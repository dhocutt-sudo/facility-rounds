<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0">
  <title>Facility Command</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
  <style>
    body { background-color: #f4f7f6; padding: 12px; font-family: -apple-system, sans-serif; }
    .card { border-radius: 12px; border: none; box-shadow: 0 2px 10px rgba(0,0,0,0.1); padding: 20px; }
    .btn-status { height: 80px; font-weight: bold; margin-bottom: 15px; width: 100%; border-radius: 12px; border: 2px solid #ddd; background-color: #fff; transition: all 0.2s; }
    .hidden { display: none; }
    .locked-header { background: #212529; color: white; padding: 12px; border-radius: 8px; font-weight: bold; text-align: center; margin-bottom: 20px; text-transform: uppercase; }
    #loading { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(255,255,255,0.95); display:none; justify-content:center; align-items:center; z-index:9999; flex-direction: column; text-align: center; }
    .staff-label { font-size: 0.75rem; color: #999; text-align: center; margin-top: 25px; }
  </style>
</head>
<body>

  <div id="loading">
    <div class="spinner-border text-primary mb-3"></div>
    <h5 id="statusMsg">Updating Registry...</h5>
  </div>

  <div id="setupView" class="card hidden">
    <h5>Staff Registration</h5>
    <input type="text" id="setupName" class="form-control mb-2" placeholder="Full Name">
    <input type="email" id="setupEmail" class="form-control mb-3" placeholder="email@bhamjcc.org">
    <button class="btn btn-primary w-100 p-3 fw-bold" onclick="saveIdentity()">Save Registration</button>
  </div>

  <div id="successView" class="card hidden" style="text-align: center;">
    <div style="font-size: 50px;">âœ…</div>
    <h3 class="mt-2">All Clear!</h3>
    <p id="successMsg" class="text-muted"></p>
    <button class="btn btn-outline-primary mt-3" onclick="location.reload()">New Report</button>
  </div>

  <div id="mainApp" class="hidden">
    <div id="navTabs" class="btn-group w-100 mb-3 hidden">
      <button class="btn btn-outline-primary active" id="t1" onclick="setMode('round')">Rounds</button>
      <button class="btn btn-outline-primary" id="t2" onclick="setMode('workorder')">Work Order</button>
    </div>

    <div id="roundForm" class="card">
      <div id="assetHeader" class="locked-header hidden"></div>
      <div id="assetPicker">
        <label class="fw-bold mb-2">Facility Status Check</label>
        <select id="assetList" class="form-select form-select-lg mb-4"></select>
      </div>
      <button class="btn btn-outline-success btn-status" onclick="doQuickSubmit('ðŸŸ¢ Online')">ðŸŸ¢ Online</button>
      <button class="btn btn-outline-warning btn-status" onclick="doQuickSubmit('ðŸŸ¡ Issue')">ðŸŸ¡ Issue</button>
      <button class="btn btn-outline-danger btn-status" onclick="doQuickSubmit('ðŸ”´ Down')">ðŸ”´ Down</button>
    </div>

    <div id="woForm" class="card hidden">
      <h5 class="mb-3">Maintenance Request</h5>
      <label class="small fw-bold">Location *</label>
      <input type="text" id="woLoc" class="form-control mb-2">
      <label class="small fw-bold">Describe Issue *</label>
      <textarea id="woIssue" class="form-control mb-2" rows="3" placeholder="Explain the problem..."></textarea>
      <label class="small fw-bold">Priority *</label>
      <select id="woPriority" class="form-select mb-3">
        <option value="Low (L): No safety risk. The request is purely cosmetic, or would be nice to have.">Low (L): Cosmetic</option>
        <option value="Medium (M): No safety risk. The damage caused by the Incident only marginally increases over time.">Medium (M): No safety risk</option>
        <option value="High (H): The safety risk and damage caused by the problem increases considerably over time.">High (H): Safety Risk</option>
        <option value="Security risk">Security Risk</option>
      </select>
      <button class="btn btn-primary w-100 p-3 fw-bold" onclick="doSubmitWO()">SUBMIT WORK ORDER</button>
    </div>

    <div class="staff-label">
      Logged in: <span id="sName"></span> | <a href="#" onclick="logout()">Logout</a>
    </div>
  </div>

  <script>
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyAKiDGXHrwJ2cEcJf9lr9ZOVV59eeCADibBpsnWg5RIBY-ikgxqfWsM80DIWlpmLEFyg/exec";
    const params = new URLSearchParams(window.location.search);
    const assetParam = params.get('asset');
    let modeParam = params.get('mode') || (assetParam ? 'round' : 'admin');

    window.onload = function() {
      const name = localStorage.getItem('staffName');
      if (!name) document.getElementById('setupView').classList.remove('hidden');
      else startApp(name);
    };

    function saveIdentity() {
      const n = document.getElementById('setupName').value;
      const e = document.getElementById('setupEmail').value;
      if (n.length < 2) return alert("Name required.");
      localStorage.setItem('staffName', n);
      localStorage.setItem('staffEmail', e);
      startApp(n);
    }

    function logout() { localStorage.clear(); location.reload(); }

    function startApp(n) {
      document.getElementById('setupView').classList.add('hidden');
      document.getElementById('mainApp').classList.remove('hidden');
      document.getElementById('sName').innerText = n;
      fetch(SCRIPT_URL).then(res => res.json()).then(list => {
           const sel = document.getElementById('assetList');
           list.forEach(a => {
             let opt = document.createElement('option');
             opt.value = a; opt.innerText = a;
             if(assetParam && a.toLowerCase() === assetParam.toLowerCase()) opt.selected = true;
             sel.appendChild(opt);
           });
      });
      if (assetParam) {
        document.getElementById('assetHeader').innerText = assetParam;
        document.getElementById('assetHeader').classList.remove('hidden');
        document.getElementById('assetPicker').classList.add('hidden');
        document.getElementById('woLoc').value = assetParam;
      } else if (modeParam === 'admin') {
        document.getElementById('navTabs').classList.remove('hidden');
      }
      setMode(modeParam);
    }

    function setMode(m) {
      modeParam = m;
      document.getElementById('roundForm').classList.toggle('hidden', m !== 'round');
      document.getElementById('woForm').classList.toggle('hidden', m !== 'workorder');
    }

    function doQuickSubmit(status) {
      const currentAsset = assetParam || document.getElementById('assetList').value;
      showLoad("Updating Registry...");
      
      fetch(SCRIPT_URL, {
        method: 'POST',
        body: JSON.stringify({
          type: "ROUND",
          asset: currentAsset,
          status: status,
          staff: localStorage.getItem('staffName')
        })
      })
      .then(res => res.json())
      .then(res => {
        document.getElementById('loading').style.display = 'none';
        if (!status.includes('ðŸŸ¢')) {
          alert(status + " recorded. Please provide details in the Work Order.");
          setMode('workorder');
        } else {
          document.getElementById('mainApp').classList.add('hidden');
          document.getElementById('successView').classList.remove('hidden');
          document.getElementById('successMsg').innerText = currentAsset + " is Online.";
        }
      });
    }

    function doSubmitWO() {
      const loc = document.getElementById('woLoc').value;
      const iss = document.getElementById('woIssue').value;
      if (!loc || !iss) return alert("Fill in required fields.");
      showLoad("Sending to Maintenance...");
      fetch(SCRIPT_URL, {
        method: 'POST',
        body: JSON.stringify({
          type: "WORKORDER",
          location: loc,
          issue: iss,
          priority: document.getElementById('woPriority').value,
          staff: localStorage.getItem('staffName'),
          email: localStorage.getItem('staffEmail')
        })
      })
      .then(res => res.json())
      .then(res => {
        document.getElementById('loading').style.display = 'none';
        document.getElementById('mainApp').classList.add('hidden');
        document.getElementById('successView').classList.remove('hidden');
        document.getElementById('successMsg').innerText = res.message;
      });
    }

    function showLoad(m) {
      document.getElementById('statusMsg').innerText = m;
      document.getElementById('loading').style.display = 'flex';
    }
  </script>
</body>
</html>
